# This references a standard debian container from the
# Docker Hub https://registry.hub.docker.com/_/debian/
# Read more about containers on our dev center
# http://devcenter.wercker.com/docs/containers/index.html
box: wercker/nodejs
# You can also use services such as databases. Read more on our dev center:
# http://devcenter.wercker.com/docs/services/index.html
# services:
    # - postgres
    # http://devcenter.wercker.com/docs/services/postgresql.html

    # - mongodb
    # http://devcenter.wercker.com/docs/services/mongodb.html

# This is the build pipeline. Pipelines are the core of wercker
# Read more about pipelines on our dev center
# http://devcenter.wercker.com/docs/pipelines/index.html
build:
    # Steps make up the actions in your pipeline
    # Read more about steps on our dev center:
    # http://devcenter.wercker.com/docs/steps/index.html
  steps:
    - install-packages:
        packages: curl
    - script:
        name: echo nodejs information
        code: |
            echo "node version $(node -v) running"
            echo "npm version $(npm -v) running"
    - script:
        name: install meteor
        code: curl https://install.meteor.com/ | sh
    - script: 
        name: check meteor version
        code: meteor --version
    - script: 
        name: build source
        code: |
            cd $WERCKER_SOURCE_DIR
            meteor build --directory $WERCKER_OUTPUT_DIR
    - script:
        name: install dependencies
        code: |
            mv $WERCKER_OUTPUT_DIR/bundle/* $WERCKER_OUTPUT_DIR
            rm -rf $WERCKER_OUTPUT_DIR/bundle
            cd $WERCKER_OUTPUT_DIR/programs/server
            npm install
            npm install fibers
    - script:
        name: move eb files
        code: |
            mv $WERCKER_SOURCE_DIR/.ebextensions $WERCKER_OUTPUT_DIR
            ls -al $WERCKER_OUTPUT_DIR

deploy:
  steps:

    - script:
        name: Install Beanstalk CLI
        code: |-
          curl -O https://bootstrap.pypa.io/get-pip.py
          sudo python get-pip.py
          sudo pip install awsebcli
          sudo mkdir -p /usr/local/aws/elasticbeanstalk
          mkdir -p "/home/ubuntu/.aws/"
          mkdir -p "$WERCKER_SOURCE_DIR/.elasticbeanstalk/"
          export PATH="/usr/local/aws/elasticbeanstalk/eb/linux/python2.7:$PATH"
          export AWS_CREDENTIAL_FILE="/home/ubuntu/.aws/credentials"
          export EBS_CONFIG_FILE="$WERCKER_SOURCE_DIR/.elasticbeanstalk/config.yml"

    - create-file:
        name: Create AWS credential file
        filename: $AWS_CREDENTIAL_FILE
        content: |-
            [default]
            aws_access_key_id = $KEY
            aws_secret_access_key = $SECRET_KEY

    # Env conditional deploy steps
    - script:
        name: Run environment specific deploy steps
        code: cat $WERCKER_SOURCE_DIR/.ebextensions/config.tpl > $EBS_CONFIG_FILE

    # Remove the existing repository and re-add everything
    # in a new repository that will be used to push it to beanstalk
    # The last line in this script add the beanstalk hooks to the
    # repository
    - script:
        name: Create deploy repository
        code: |-
            cd $WERCKER_SOURCE_DIR
            git config --global user.email "pleasemailus@wercker.com"
            git config --global user.name "wercker"

            rm -rf $WERCKER_SOURCE_DIR/.git
            echo ".elasticbeanstalk/" > .gitignore
            git init
            git add .
            git commit -m "deploy commit"

    # Check if beanstalk CLI is there
    - script:
        name: Initialize Beanstalk
        code: |-
            eb init

    # Do the actual deploy via the aws.push hook that the Beanstalk CLI adds
    - script:
        name: Push it!
        code: |-
          git checkout master
          eb deploy